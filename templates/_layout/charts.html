<!-- Configuration Plotly globale pour le thème sombre -->
<script>
window.PlotlyConfig = {
    displayModeBar: false,
    responsive: true
};

window.PlotlyLayout = {
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: {
        color: '#e5e7eb',
        family: 'Inter, system-ui, sans-serif'
    },
    margin: { t: 40, r: 20, b: 40, l: 40 },
    showlegend: true,
    legend: {
        bgcolor: 'rgba(0,0,0,0)',
        bordercolor: 'rgba(0,0,0,0)',
        font: { color: '#e5e7eb' }
    },
    xaxis: {
        gridcolor: '#374151',
        linecolor: '#4b5563',
        tickcolor: '#4b5563',
        zerolinecolor: '#4b5563'
    },
    yaxis: {
        gridcolor: '#374151',
        linecolor: '#4b5563',
        tickcolor: '#4b5563',
        zerolinecolor: '#4b5563'
    }
};
</script>

<!-- Macro pour graphique en ligne (évolution temporelle) -->
{% macro line_chart(chart_id, data, title="", height="400px") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ data|tojson }};
    const traces = data.map((series, index) => ({
        x: series.x,
        y: series.y,
        type: 'scatter',
        mode: 'lines+markers',
        name: series.name,
        line: {
            color: ['#38bdf8', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'][index % 5],
            width: 3
        },
        marker: {
            size: 6,
            color: ['#38bdf8', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'][index % 5]
        }
    }));
    
    const layout = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        hovermode: 'x unified',
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', traces, layout, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique en barres -->
{% macro bar_chart(chart_id, data, title="", height="400px", orientation="v") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data_{{ chart_id.replace('-', '_') }} = {{ data|tojson }};
    
    const trace_{{ chart_id.replace('-', '_') }} = {
        {% if orientation == 'h' %}
        y: data_{{ chart_id.replace('-', '_') }}.labels,
        x: data_{{ chart_id.replace('-', '_') }}.values,
        orientation: 'h',
        {% else %}
        x: data_{{ chart_id.replace('-', '_') }}.labels,
        y: data_{{ chart_id.replace('-', '_') }}.values,
        {% endif %}
        type: 'bar',
        marker: {
            color: data_{{ chart_id.replace('-', '_') }}.colors || '#38bdf8',
            line: {
                color: '#1f2937',
                width: 1
            }
        },
        {% if orientation == 'h' %}
        hovertemplate: '<b>%{y}</b><br>Valeur: %{x}<extra></extra>'
        {% else %}
        hovertemplate: '<b>%{x}</b><br>Valeur: %{y}<extra></extra>'
        {% endif %}
    };
    
    const layout_{{ chart_id.replace('-', '_') }} = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        {% if orientation == 'h' %}
        margin: { t: 40, r: 20, b: 40, l: 120 },
        {% endif %}
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', [trace_{{ chart_id.replace('-', '_') }}], layout_{{ chart_id.replace('-', '_') }}, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique en secteurs (pie chart) -->
{% macro pie_chart(chart_id, data, title="", height="400px") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ data|tojson }};
    
    const trace = {
        labels: data.labels,
        values: data.values,
        type: 'pie',
        marker: {
            colors: data.colors || ['#38bdf8', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'],
            line: {
                color: '#1f2937',
                width: 2
            }
        },
        textinfo: 'label+percent',
        textposition: 'auto',
        textfont: {
            color: '#e5e7eb'
        },
        hovertemplate: '<b>%{label}</b><br>Valeur: %{value}<br>Pourcentage: %{percent}<extra></extra>'
    };
    
    const layout = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        showlegend: true,
        legend: {
            orientation: 'v',
            x: 1.05,
            y: 0.5,
            bgcolor: 'rgba(0,0,0,0)',
            bordercolor: 'rgba(0,0,0,0)',
            font: { color: '#e5e7eb' }
        },
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', [trace], layout, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique en nuage de points (scatter) -->
{% macro scatter_chart(chart_id, data, title="", height="400px", x_title="", y_title="") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ data|tojson }};
    
    const trace = {
        x: data.x,
        y: data.y,
        mode: 'markers',
        type: 'scatter',
        marker: {
            size: data.sizes || 8,
            color: data.colors || '#38bdf8',
            opacity: 0.7,
            line: {
                color: '#1f2937',
                width: 1
            }
        },
        text: data.labels || [],
        hovertemplate: '<b>%{text}</b><br>{{ x_title or "X" }}: %{x}<br>{{ y_title or "Y" }}: %{y}<extra></extra>'
    };
    
    const layout = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        xaxis: {
            ...window.PlotlyLayout.xaxis,
            title: {
                text: '{{ x_title }}',
                font: { color: '#e5e7eb' }
            }
        },
        yaxis: {
            ...window.PlotlyLayout.yaxis,
            title: {
                text: '{{ y_title }}',
                font: { color: '#e5e7eb' }
            }
        },
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', [trace], layout, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique en aires empilées -->
{% macro area_chart(chart_id, data, title="", height="400px") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ data|tojson }};
    const traces = data.map((series, index) => ({
        x: series.x,
        y: series.y,
        type: 'scatter',
        mode: 'lines',
        name: series.name,
        fill: 'tonexty',
        fillcolor: `rgba(${['56, 189, 248', '34, 197, 94', '245, 158, 11', '239, 68, 68', '139, 92, 246'][index % 5]}, 0.3)`,
        line: {
            color: ['#38bdf8', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'][index % 5],
            width: 2
        }
    }));
    
    const layout = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        hovermode: 'x unified',
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', traces, layout, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique de jauge -->
{% macro gauge_chart(chart_id, value, title="", max_value=100, height="300px") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4 text-center">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const value = {{ value }};
    const maxValue = {{ max_value }};
    
    const trace = {
        type: "indicator",
        mode: "gauge+number+delta",
        value: value,
        domain: { x: [0, 1], y: [0, 1] },
        title: { 
            text: "{{ title }}",
            font: { color: '#e5e7eb', size: 16 }
        },
        gauge: {
            axis: { 
                range: [null, maxValue],
                tickcolor: '#4b5563',
                tickfont: { color: '#e5e7eb' }
            },
            bar: { color: value >= maxValue * 0.8 ? '#22c55e' : value >= maxValue * 0.6 ? '#f59e0b' : '#ef4444' },
            steps: [
                { range: [0, maxValue * 0.6], color: 'rgba(239, 68, 68, 0.2)' },
                { range: [maxValue * 0.6, maxValue * 0.8], color: 'rgba(245, 158, 11, 0.2)' },
                { range: [maxValue * 0.8, maxValue], color: 'rgba(34, 197, 94, 0.2)' }
            ],
            threshold: {
                line: { color: "#e5e7eb", width: 4 },
                thickness: 0.75,
                value: maxValue * 0.9
            }
        },
        number: {
            font: { color: '#e5e7eb', size: 24 }
        }
    };
    
    const layout = {
        ...window.PlotlyLayout,
        margin: { t: 20, r: 20, b: 20, l: 20 }
    };
    
    Plotly.newPlot('{{ chart_id }}', [trace], layout, window.PlotlyConfig);
});
</script>
{% endmacro %}

<!-- Macro pour graphique en barres horizontales empilées -->
{% macro stacked_bar_chart(chart_id, data, title="", height="400px") %}
<div class="bg-gray-900 rounded-2xl shadow-lg p-6">
    {% if title %}
    <h3 class="text-lg font-semibold text-white mb-4">{{ title }}</h3>
    {% endif %}
    <div id="{{ chart_id }}" style="height: {{ height }};"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ data|tojson }};
    const traces = data.series.map((series, index) => ({
        x: series.values,
        y: data.categories,
        name: series.name,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: ['#38bdf8', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'][index % 5]
        }
    }));
    
    const layout = {
        ...window.PlotlyLayout,
        title: {
            text: '{{ title }}',
            font: { color: '#e5e7eb', size: 16 }
        },
        barmode: 'stack',
        margin: { t: 40, r: 20, b: 40, l: 120 },
        hoverlabel: {
            bgcolor: '#1f2937',
            bordercolor: '#374151',
            font: { color: '#e5e7eb' }
        }
    };
    
    Plotly.newPlot('{{ chart_id }}', traces, layout, window.PlotlyConfig);
});
</script>
{% endmacro %}
