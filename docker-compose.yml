version: "3.9"

services:

  web:
    build: .
    container_name: linkguardian_web
    restart: unless-stopped
    volumes:
      - .:/app
    ports:
      - "5000:5000"
    depends_on:
      - postgres
      - rabbitmq
    environment:
      FLASK_ENV: development
      FLASK_DEBUG: 1
      PYTHONUNBUFFERED: 1          # ‚Üê AJOUTER CECI
      WATCHDOG_POLLING: "true"     # ‚Üê ET CECI pour am√©liorer le hot-reload
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
      DB_HOST: postgres
      DB_PORT: 5432
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # üî• WORKER 1 : URGENT + STANDARD
  # Priorit√© aux v√©rifications manuelles imm√©diates
  # ============================================
  worker_1:
    build: .
    container_name: linkguardian_worker_1
    restart: always
    command: celery -A celery_app.celery worker -Q urgent,standard --concurrency=6 --loglevel=INFO --hostname=worker1@%h
    depends_on:
      - postgres
      - rabbitmq
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
      DB_HOST: postgres
      DB_PORT: 5432
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # üí™ WORKER 2 : STANDARD
  # D√©di√© aux imports massifs et v√©rifications auto
  # ============================================
  worker_2:
    build: .
    container_name: linkguardian_worker_2
    restart: always
    command: celery -A celery_app.celery worker -Q standard --concurrency=8 --loglevel=INFO --hostname=worker2@%h
    depends_on:
      - postgres
      - rabbitmq
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
      DB_HOST: postgres
      DB_PORT: 5432
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # üåä WORKER 3 : STANDARD + WEEKLY
  # G√®re la charge mixte et les t√¢ches planifi√©es
  # ============================================
  worker_3:
    build: .
    container_name: linkguardian_worker_3
    restart: always
    command: celery -A celery_app.celery worker -Q standard,weekly --concurrency=8 --loglevel=INFO --hostname=worker3@%h
    depends_on:
      - postgres
      - rabbitmq
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
      DB_HOST: postgres
      DB_PORT: 5432
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # ‚è∞ CELERY BEAT : Planificateur
  # ============================================
  beat:
    build: .
    container_name: linkguardian_beat
    restart: always
    command: celery -A celery_app.celery beat --loglevel=INFO
    depends_on:
      - postgres
      - rabbitmq
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
      DB_HOST: postgres
      DB_PORT: 5432
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # üìä FLOWER : Monitoring Celery (OPTIONNEL)
  # Interface web pour surveiller les workers
  # Accessible sur http://localhost:5555
  # ============================================
  flower:
    build: .
    container_name: linkguardian_flower
    restart: unless-stopped
    command: celery -A celery_app.celery flower --port=5555
    ports:
      - "5555:5555"
    depends_on:
      - rabbitmq
      - worker_1
      - worker_2
      - worker_3
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # ============================================
  # üóÑÔ∏è BASE DE DONN√âES
  # ============================================
  postgres:
    image: postgres:15
    container_name: linkguardian_postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Karavel123#
      POSTGRES_DB: site
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # ============================================
  # üê∞ MESSAGE BROKER
  # ============================================
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: linkguardian_rabbitmq
    restart: always
    ports:
      - "5672:5672"   # Port AMQP
      - "15672:15672" # Interface web management
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  adminer:
    image: adminer
    restart: always
    ports:
      - "8080:8080"

volumes:
  pgdata:

# ============================================
# üìä CAPACIT√âS TOTALES DU SYST√àME
# ============================================
# Worker 1: 6 t√¢ches simultan√©es (urgent + standard)
# Worker 2: 8 t√¢ches simultan√©es (standard)
# Worker 3: 8 t√¢ches simultan√©es (standard + weekly)
# 
# TOTAL: 22 t√¢ches simultan√©es
# Avec prefetch_multiplier=4 : 88 t√¢ches en pr√©chargement
#
# Performance estim√©e :
# - Import 100 sites : ~1 minute
# - Import 500 sites : ~4 minutes
# - V√©rification urgente : <5 secondes
#
# Monitoring :
# - Flower : http://localhost:5555
# - RabbitMQ Management : http://localhost:15672 (admin/admin123)