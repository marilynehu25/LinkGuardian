{% extends "_layout/base.html" %}
{% from "_layout/components.html" import content_card, status_badge, alert, note_lecture %}
{% from "_layout/charts_simple.html" import pie_chart, bar_chart, donut_chart %}

{% block title %}Ancres - LinkGuardian{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Ancres de liens</h1>
            <p class="text-gray-400 mt-1">Analysez la diversité et l'optimisation de vos textes d'ancrage</p>
        </div>
    </div>
    
    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-white">{{ stats.total_anchors }}</div>
            <div class="text-sm text-gray-400">Ancres uniques</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-accent">{{ stats.branded_percentage }}%</div>
            <div class="text-sm text-gray-400">Ancres de marque</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-primary">{{ stats.exact_match_percentage }}%</div>
            <div class="text-sm text-gray-400">Correspondance exacte</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-warn">{{ stats.generic_percentage }}%</div>
            <div class="text-sm text-gray-400">Ancres génériques</div>
        </div>
        
    </div>
    
    <!-- Graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Distribution par type -->
        {{ donut_chart(
            chart_id="anchor-types",
            title="Répartition par type d'ancre",
            data=pie_data
        ) }}
        
        <!-- Top ancres les plus utilisées -->
        {{ bar_chart(
            chart_id="top-anchors-usage",
            title="Top 10 ancres les plus utilisées",
            orientation="h",
            data=top_data 
        ) }}
    </div>
    
    <!-- Barre de recherche -->
    <form
        hx-get="/anchors/partial/table"
        hx-target="#anchors-table"
        hx-swap="innerHTML"
        hx-include="this"
        class="grid grid-cols-1 md:grid-cols-5 gap-4 bg-gray-900 p-4 rounded-xl"
        hx-trigger="change"
    >

        <!-- Recherche -->
        <div>
            <label class="text-gray-400 text-sm mb-1">Recherche</label>
            <input type="text" name="q" value="{{ filters.q }}"
                placeholder="URL, ancre..."
                class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
        </div>

        <!-- Tag -->
        <div>
            <label class="text-gray-400 text-sm mb-1">Tag</label>
            <select name="tag" class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
                <option value="">Tous</option>
                {% for t in tags %}
                    <option value="{{ t.valeur }}"
                            {% if filters.tag == t.valeur %}selected{% endif %}>
                        {{ t.valeur }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Source -->
        <div>
            <label class="text-gray-400 text-sm mb-1">Source</label>
            <select name="source" class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
                <option value="">Toutes</option>
                {% for s in sources %}
                    <option value="{{ s.nom }}"
                            {% if filters.source == s.nom %}selected{% endif %}>
                        {{ s.nom }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Tri -->
        <div>
            <label class="text-gray-400 text-sm mb-1">Trier par</label>
            <select name="sort" class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
                <option value="count"  {% if filters.sort == 'count' %}selected{% endif %}>Fréquence (utilisations)</option>
                <option value="length" {% if filters.sort == 'length' %}selected{% endif %}>Longueur</option>
            </select>
        </div>

        <!-- Bouton -->
        <div class="flex items-end">
            <button type="submit"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-full flex items-center gap-2 shadow-md transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                Valider
            </button>
            {{ note_lecture("Afin d'actualiser les statistiques et les liens, n'oubliez pas d'appuyer sur Valider.
            Pour rechercher par un tag, saisissez d'abord le nom du tag, puis sélectionner les labels et appuyez sur Entrée.") }}
        </div>

    </form>


    <div id="anchors-table">
        {% include "anchors/_anchors_table.html" with context %}
    </div>

</div>
{% endblock %}
